@page
@model LOVA.API.Pages.Lova.ActivationsModel
@{
    Layout = "~/Pages/Shared/_layoutLive.cshtml";
    ViewData["Title"] = "Live ";
}



<div class="container-fluid">
    <div class="row mt-2 ml-5">
        <div class="col-md">
            <span style="font-size: 18px; color: #5ab25e">
                <i class="fas fa-square"></i>
            </span>
            <span class="tableLive mt-1">&nbsp; Varit aktiv senaste veckan</span>
            <span class="ml-2" style="font-size: 18px;color: #fc9005">
                <i class="fas fa-square"></i>
            </span>
            <span class="tableLive mt-1">&nbsp; Aktiv</span>
            <span class="ml-2" style="font-size: 18px;color: #e73e3a;">
                <i class="fas fa-square"></i>
            </span>
            <span class="tableLive mt-1">&nbsp; Aktiv mer än 100 s</span>
            <span class="ml-2" style="font-size: 18px;color: #990000;">
                <i class="far fa-square"></i>
            </span>
            <span class="tableLive mt-1">&nbsp; Aktiv mer än 10 min</span>
            <span class="ml-2" style="font-size: 18px;color: #a6a6a6">
                <i class="fas fa-square"></i>
            </span>
            <span class="tableLive mt-1">&nbsp; Ej aktiv på en vecka</span>
            <button type="button" class="btn btn-outline-secondary btn-sm ml-2" id="resetSquare">@ViewData["buttonText"]</button>
        </div>
        
        
    </div>


    <div class="row m-3">
        <div class="col-md-2 mr-2">
            <div class="row">
                <h6>Slinga 1</h6>
            </div>
            <div class="row">
                <table border="1" class="tableLive live">
                    @foreach (var r in "ABCDEFGHIJKLMNOP")
                    {
                        <tr>
                            @foreach (var d in "12345678")
                            {
                                <td id="1@($"{@r}{@d}")" class="tableLiveTd tableLiveTdStart" width="50" height="30">@r@d</td>
                            }

                        </tr>

                    }

                </table>
            </div>
        </div>
        <div class="col-md-2 mr-2">
            <div class="row">
                <h6>Slinga 2</h6>
            </div>
            <div class="row">
                <table border="1" class="tableLive live">
                    @foreach (var r in "ABCDEFGHIJKLMNOP")
                    {
                        <tr>
                            @foreach (var d in "12345678")
                            {
                                <td id="2@($"{@r}{@d}")" class="tableLiveTd tableLiveTdStart" width="50" height="30">@r@d</td>
                            }

                        </tr>

                    }

                </table>
            </div>
        </div>
        <div class="col-md-2 mr-2">
            <div class="row">
                <h6>Slinga 3</h6>
            </div>
            <div class="row">
                <table border="1" class="tableLive live">
                    @foreach (var r in "ABCDEFGHIJKLMNOP")
                    {
                        <tr>
                            @foreach (var d in "12345678")
                            {
                                <td id="3@($"{@r}{@d}")" class="tableLiveTd tableLiveTdStart" width="50" height="30">@r@d</td>
                            }

                        </tr>

                    }

                </table>
            </div>
        </div>
        <div class="col-md-2">
            <div class="row">
                <div class="col-sm-12">
                    <div class="row">
                        <h6 id="address"></h6><h6 class="ml-1"><small id="masterNode" class="text-muted">Välj en adress</small></h6>
                    </div>
                    <div class="row">
                        <div class="card w-100">
                            <div class="card-body card-activation">
                                <table class="tableLive" width="100%">
                                    <tr>
                                        <td width="50%">Aktiverad:</td>
                                        <td id="activationTime" width="40%"></td>
                                        <td width="10%"></td>
                                    </tr>
                                    <tr>
                                        <td width="50%">Senaste gångtid:</td>
                                        <td width="40%" id="activationRunningTime"></td>
                                        <td width="10%"></td>
                                    </tr>
                                    <tr>
                                        <td width="50%">Snitt gångtid:</td>
                                        <td width="40%" id="activationAverage"></td>
                                        <td width="10%"><i class="far fa-trash-alt btnDelete" data-type="AverageActivity"></i></td>
                                    </tr>
                                    <tr>
                                        <td width="50%" data-toggle="tooltip" data-placement="top" title="Antal aktiveringar pågående timme. ">Aktiveringar timme:</td>
                                        <td width="40%" id="activationCount"></td>
                                        <td width="10%"></td>
                                    </tr>
                                    <tr>
                                        <td width="50%" data-toggle="tooltip" data-placement="top" title="Antal aktiveringar pågående dygn. ">Aktiveringar dygn:</td>
                                        <td width="40%" id="activationDailyCount"></td>
                                        <td width="10%"></td>
                                    </tr>
                                </table>
                            </div>

                            <div class="card-body card-deactivation">
                                <table class="tableLive" width="100%">
                                    <tr>
                                        <td width="50%">Inaktiv:</td>
                                        <td width="40%" id="deActivationTime"></td>
                                        <td width="10%"></td>
                                    </tr>
                                    <tr>
                                        <td width="50%">Senaste vilotid:</td>
                                        <td width="40%" id="deActivationRunningTime"></td>
                                        <td width="10%"></td>
                                    </tr>
                                    <tr>
                                        <td width="50%">Snitt vilotid :</td>
                                        <td width="40%" id="deActivationRestAverage"></td>
                                        <td width="10%"><i class="far fa-trash-alt btnDelete" data-type="AverageRest"></i></td> 
                                    </tr>
                                </table>
                            </div>

                        </div>
                    </div>
                    <div class="row">
                        <h6 id="address"></h6><h6 class="ml-1"><small id="masterNode" class="text-muted">Senaste aktiveringarna</small></h6>
                    </div>
                    <div class="row">
                        <div class="card w-100" style="height: 280px; overflow-y: scroll;">
                            <div class="card-body card-activation" id="drainHistory">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-auto">
            <div class="row">
                <h6>Aktiviteter</h6><h6 class="ml-1"><small id="connectionStatus" class="text-muted"></small></h6>
            </div>
            <div class="row">
                <ul id="messagesList" class="tableLive" style="height: 510px; width: 300px; list-style-type: none; overflow-y:scroll; ">
                    <li></li>
                </ul>

            </div>
        </div>
    </div>

</div>


<script src="~/lib/moment/min/moment.min.js"></script>
<script src="~/lib/moment/min/moment-with-locales.min.js"></script>
<script src="~/lib/signalr/dist/browser/signalr.js"></script>
<script src="~/js/DrainPush.js"></script>

@section Scripts {

    <script>

       var longActivationTime = "@LOVA.API.Services.MyConsts.LongActivationTime";
       console.log(longActivationTime);


        moment.locale('sv');  // Set moment to Swedish date and time

        $(document).ready(function () {


            // Remove not used addresses from the grids

            var notActive1 = ["#1A5", "#1A6", "#1B5", "#1B6", "#1C5", "#1C6", "#1E6", "#1F4", "#1F5", "#1F6", "#1G5", "#1G6", "#1I3", "#1I4", "#1I5", "#1I6", "#1J5", "#1J6", "#1K6", "#1L6", "#1N6", "#1O6", "#1P4", "#1P5", "#1P6",]
            var notActive2 = ["#2A4", "#2A5", "#2A6", "#2B4", "#2B5", "#2B6", "#2C4", "#2C5", "#2C6", "#2D4", "#2D5", "#2D6", "#2E3", "#2E4", "#2E5", "#2E6", "#2F3", "#2F4", "#2F5", "#2F6", "#2G3", "#2G4", "#2G5", "#2G6", "#2H3", "#2H4", "#2H5", "#2H6", "#2I5", "#2I6", "#2J2", "#2J3", "#2J4", "#2J5", "#2J6", "#2K4", "#2K5", "#2K6", "#2L4", "#2L5", "#2L6", "#2M2", "#2M3", "#2M4", "#2M5", "#2M6", "#2N1", "#2N2", "#2N3", "#2N4", "#2N5", "#2N6", "#2N7", "#2N8", "#2O3", "#2O4", "#2O5", "#2O6", "#2O7", "#2O8", "#2P2", "#2P3", "#2P4", "#2P5", "#2P6", "#2P7", "#2P8",]
            var notActive3 = ["#3A4", "#3A5", "#3A6", "#3B3", "#3B4", "#3B5", "#3B6", "#3C4", "#3C5", "#3C6", "#3D5", "#3D6", "#3E3", "#3E4", "#3E5", "#3E6", "#3F5", "#3F6", "#3G3", "#3G4", "#3G5", "#3G6", "#3H3", "#3H4", "#3H5", "#3H6", "#3I3", "#3I4", "#3I5", "#3I6", "#3J3", "#3J4", "#3J5", "#3J6", "#3K5", "#3K6", "#3L4", "#3L5", "#3L6", "#3M3", "#3M4", "#3M5", "#3M6", "#3N3", "#3N4", "#3N5", "#3N6", "#3O3", "#3O4", "#3O5", "#3O6", "#3P1", "#3P2", "#3P3", "#3P4", "#3P5", "#3P6", "#3P7", "#3P8"]

            notActive1.forEach(greyOut)
            notActive2.forEach(greyOut)
            notActive3.forEach(greyOut)

            function greyOut(item, index) {
                $(item).css("background-color", "lightgrey").css("color", "lightgrey").css("cursor", "not-allowed");
            }

            var statesAvailable = JSON.parse(@Html.Raw(Json.Serialize(ViewData["qResult"])));



             jQuery.each( statesAvailable, function( i, val ) {
                           // console.log(val);
                           if (val["IsActive"])
                           {
                               var dateNow = new Date();
                               var secondsBetween = moment(dateNow).diff(moment(val["TimeUp"]), "seconds", false)
                               if (secondsBetween > longActivationTime)
                               {
                                   
                                   // Color red
                                   $("#" + val["RowKey"]).attr("data-timeup", val["TimeUp"]).removeClass("tableLiveTdStart").addClass("active").addClass("tableLiveTdLongActive");

                                   if (secondsBetween > 600) {
                                       $("#" + val["RowKey"]).addClass("redSolidBorder");
                                   }
                               } else {
                                   // color orange
                                   $("#" + val["RowKey"]).attr("data-timeup", val["TimeUp"]).removeClass("tableLiveTdStart").addClass("active").addClass("tableLiveTdActive");
                               }

                           } else
                           {
                               $("#" + val["RowKey"]).removeClass("tableLiveTdStart").addClass("tableLiveTdNonActive");
                           }
               });


            var noActivations = JSON.parse(@Html.Raw(Json.Serialize(ViewData["noActivations"])));

            jQuery.each(noActivations, function (i, val) {
                 // Color
                $("#" + val["RowKey"]).removeClass("tableLiveTdNonActive tableLiveTdActive").addClass("tableLiveTdStart");

            }); 



            $(".live").on("click", "td", function () {

                var cid = $(this).attr('id');

                $("#activationTime").text("");
                $("#deActivationTime").text("");
                $("#activationRunningTime").text("");
                $("#deActivationRunningTime").text("");
                $("#activationCount").text("");
                $("#activationDailyCount").text("");
                $("#activationAverage").text("");
                $("#deActivationRestAverage").text("");
                $("#drainHistory").html("Data laddas...");


                // Function in DrainPush.js
                drainUpdate(cid);


                $("#address").text(cid);


                switch(cid) {
                    case "2P1":
                    $("#masterNode").text(" Vakuumpumparna");
                    break;
                    case "2O1":
                    $("#masterNode").text(" A-larm");
                    break;
                    case "2O2":
                    $("#masterNode").text(" B-larm");
                    break;
                    case "3L2":
                    $("#masterNode").text(" Slinga 3 (Westin)");
                    break;
                    case "3C1":
                    $("#masterNode").text(" Slinga 3 (Tempelman)");
                    break;
                    default:
                    $("#masterNode").text(" Slinga " + cid.charAt(0));
                    break;
                }


                // TODO: Jquery get data for the last 24 h
                $.ajax({
                    type: "GET",
                    url: "/Lova/Activations?handler=DrainHistory",
                    data: { drain: cid },
                    success: function (response) {
                        $("#drainHistory").html(response);
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                });

            });


            $("#resetSquare").click(function () {
                $("td").removeClass("redSolidBorder");

                $.ajax({
                    type: "GET",
                    url: "/Lova/Activations?handler=ResetGrids",
                    success: function (response) {
                        location.reload();
                       
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                    });
            });

            $(".btnDelete").click(function() {
                var t = $(this).data('type');
                var cid = $("#address").text();

                if (cid)
                {
                     $.ajax({
                    type: "GET",
                    url: "/Lova/Activations?handler=RemoveColumn",
                    data: { drain: cid, apa: t },
                    success: function (response) {
                       if (t == "AverageActivity")
                       {
                           $("#activationAverage").text("0");
                       }else
                       {
                           $("#deActivationRestAverage").text("0");
                       }
                       
                    },
                    failure: function (response) {
                        alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                });
                } else
                {
                    alert("Välj först en adress.");
                }
               


            });

             

        })
    </script>
}